#!/usr/bin/env bash
# Pre-commit Hook: Verhindert Commits ohne aktuellen DONELOG-Eintrag,
# wenn Code unter app/, scripts/ oder utils/ geändert wurde.
set -euo pipefail

# Sammle geänderte Dateien im Index (staged)
CHANGED=$(git diff --cached --name-only | tr '\n' ' ')

# Wenn nichts geändert ist, einfach durchlassen
if [ -z "$CHANGED" ]; then
  exit 0
fi

# Prüfen, ob relevante Pfade betroffen sind
if echo "$CHANGED" | grep -Eq '^(app/|scripts/|utils/)' ; then
  if ! grep -q "$(date +%Y)" docs/DONELOG.txt ; then
    echo "\n✖ DONELOG fehlt oder hat keinen Eintrag für dieses Jahr."
    echo "   Bitte 'python scripts/append_done.py "Kurzbeschreibung"' ausführen und erneut committen." >&2
    exit 1
  fi
fi

# Markdownlint für geänderte Markdown-Dateien (README.md, docs/*.md etc.)
MD_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -Ei '\.md$' || true)
if [ -n "${MD_FILES}" ]; then
  if command -v npx >/dev/null 2>&1; then
    echo "→ Prüfe Markdown mit markdownlint-cli2"
    if ! npx --yes markdownlint-cli2 --config .markdownlint-cli2.jsonc ${MD_FILES}; then
      echo "⚠ markdownlint-cli2 hat Probleme gefunden. Versuche automatische Korrektur …"
      if npx --yes markdownlint-cli2-fix --config .markdownlint-cli2.jsonc ${MD_FILES}; then
        echo "✔ Fixes angewendet. Bitte Änderungen prüfen und erneut committen."
        git add ${MD_FILES} || true
      else
        echo "✖ markdownlint-cli2 --fix fehlgeschlagen. Bitte manuell beheben (siehe VS Code Tasks)." >&2
      fi
      exit 1
    fi
  elif command -v markdownlint-cli2 >/dev/null 2>&1; then
    echo "→ Prüfe Markdown mit markdownlint-cli2 (global)"
    if ! markdownlint-cli2 --config .markdownlint-cli2.jsonc ${MD_FILES}; then
      echo "⚠ markdownlint-cli2 hat Probleme gefunden. Bitte globales Tool für Fix verwenden: 'markdownlint-cli2-fix'." >&2
      exit 1
    fi
  else
    echo "[WARN] markdownlint-cli2 nicht gefunden. Überspringe Markdown-Prüfung. Installieren: 'npm install -g markdownlint-cli2'" >&2
  fi
fi

exit 0
